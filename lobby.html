<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lobby - Bomb Party</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #4e54c8, #8f94fb);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .container {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 2rem;
      width: 100%;
      max-width: 420px;
      color: white;
      text-align: center;
      position: relative;
    }
    button {
      width: 100%;
      padding: 0.75rem;
      border: none;
      border-radius: 10px;
      background: rgba(255,255,255,0.3);
      color: white;
      font-size: 1rem;
      margin: 0.5rem 0;
      cursor: pointer;
    }
    button:hover {
      background: rgba(255,255,255,0.5);
    }
    .avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 2px solid white;
      object-fit: cover;
      margin: 0.25rem;
    }
    #playerList {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      max-height: 150px;
      overflow-y: auto;
    }
    #modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #modal-content {
      background: white;
      color: black;
      padding: 1rem 2rem;
      border-radius: 10px;
      width: 90%;
      max-width: 300px;
      text-align: center;
    }
    .small-text {
      font-size: 0.8rem;
      opacity: 0.8;
      cursor: pointer;
      margin-top: 0.5rem;
    }
    .top-bar {
      position: absolute;
      top: 10px;
      left: 10px;
      cursor: pointer;
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="top-bar" onclick="leaveRoom()">&lt; Back</div>
  <h2>Lobby</h2>
  <h3>Room ID: <span id="roomIdText"></span></h3>
  <h4>Your ID: <span id="deviceIdText"></span></h4>
  <div id="playerList"></div>
  <button onclick="openInviteModal()">Invite Player</button>
  <button id="startButton" style="display:none;" onclick="startGame()">Start Game</button>
</div>

<div id="modal">
  <div id="modal-content">
    <h3>Invite Player</h3>
    <input type="text" id="inviteInput" placeholder="Enter Player ID" style="width:100%;padding:0.5rem;margin:0.5rem 0;">
    <button onclick="sendInvite()">Send Invite</button>
    <button onclick="closeModal()" style="background:red;">Cancel</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
import { getDatabase, ref, onValue, set, remove, update, off, get } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyANkJLaIZwhqwYpgVUzZsIBUtenNMW2QQ0",
  authDomain: "kbbig-s.firebaseapp.com",
  databaseURL: "https://kbbig-s-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "kbbig-s",
  storageBucket: "kbbig-s.appspot.com",
  messagingSenderId: "616380393795",
  appId: "1:616380393795:web:f95558aadf8b4c520327f6"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const roomId = localStorage.getItem("roomId");
const playerName = localStorage.getItem("playerName");
const deviceId = localStorage.getItem("deviceId");

if (!roomId || !playerName) {
  window.location.href = "index.html";
}

const roomIdText = document.getElementById("roomIdText");
const deviceIdText = document.getElementById("deviceIdText");
const playerList = document.getElementById("playerList");
const startButton = document.getElementById("startButton");
const modal = document.getElementById("modal");

roomIdText.innerText = roomId;
deviceIdText.innerText = deviceId;

const roomRef = ref(db, `rooms/${roomId}`);

onValue(roomRef, snap => {
  const data = snap.val();
  if (!data || !data.players || !data.players[playerName]) {
    window.location.href = "index.html";
    return;
  }

  playerList.innerHTML = "";

  for (const [name, info] of Object.entries(data.players)) {
    const img = document.createElement("img");
    img.src = info.avatar || "defaulticon.png";
    img.className = "avatar";
    img.title = name;
    playerList.appendChild(img);
  }

  if (data.currentTurn === playerName && data.status === "waiting") {
    startButton.style.display = "block";
  } else {
    startButton.style.display = "none";
  }
});

window.openInviteModal = () => {
  modal.style.display = "flex";
};

window.closeModal = () => {
  modal.style.display = "none";
};

window.sendInvite = async () => {
  const inviteId = document.getElementById("inviteInput").value.trim();
  if (!inviteId) return alert("Enter an ID");
  alert("Invitation sent to " + inviteId);
  closeModal();
};

window.leaveRoom = async () => {
  off(roomRef);
  try {
    const snap = await get(roomRef);
    const data = snap.val();

    if (data) {
      if (data.currentTurn === playerName) {
        const players = Object.keys(data.players || {}).filter(p => p !== playerName);
        if (players.length > 0) {
          await update(roomRef, { currentTurn: players[0] });
        } else {
          await remove(roomRef);
          window.location.href = "index.html";
          return;
        }
      }
      await remove(ref(db, `rooms/${roomId}/players/${playerName}`));
    }
  } catch (err) {
    console.error("Failed to leave room:", err);
  }

  window.location.href = "index.html";
};

window.startGame = async () => {
  await update(roomRef, { status: "playing" });
  window.location.href = "game.html";
};
</script>
</body>
</html>
